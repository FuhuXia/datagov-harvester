{% extends 'base.html' %}

{% block title %}
<title>View Harvest Job Data</title>
{% endblock %}

{% block content %}
<div class="wrapper job-data">
    {% if not data.harvest_job_id %}
    <h2>Whooops!</h2>
    <p>Looks like you navigated to a job that doesn't exist.</p>
    {% else %}
    <h1>Details for Harvest Job Id: {{data.harvest_job_id}}</h1>
    <p>For Harvest Source Id: <a
            href="{{ url_for('harvest.view_harvest_source_data', source_id=data.harvest_job.harvest_source_id) }}">
            {{data.harvest_job.harvest_source_id}}
        </a>
    </p>
    <h2>Job Info</h2>
    <div class="config-table">
        <table class="table">
            {% for key, value in data.harvest_job_dict.items() %}
            <tr>
                <td>{{key}}:</td>
                <td>{{value}}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% if session['user'] and data.harvest_job.status == "in_progress" %}
    <div class="config-actions">
        <ul class="usa-button-group">
            <li class="usa-button-group__item">
                <a href="{{ url_for('harvest.cancel_harvest_job', job_id=data.harvest_job_id)}}">
                    <button class="usa-button usa-button--secondary">Cancel</button>
                </a>
            </li>
        </ul>
    </div>
    {% endif %}
    <div class="section my-3">
        <h2>Job Error Table</h2>
        {% if not data.harvest_job.errors %}
        No job errors found
        {% else %}
        {% set error_type = "job" %}
        <a href="{{ url_for('harvest.download_harvest_errors_by_job', job_id=data.harvest_job_id, error_type=error_type)}}">
            <button class="btn btn-primary">download job errors as .csv</button>
        </a>
        <div class="usa-table-container--scrollable" tabindex="0">
            <table class="usa-table usa-table--striped">
                <caption> Harvest Job Errors for {{data.harvest_job_id}} </caption>
                <thead>
                    <tr>
                        <th data-sortable scope="col" role="columnheader">Date Created</th>
                        <th data-sortable scope="col" role="columnheader">Id</th>
                        <th data-sortable scope="col" role="columnheader">Type</th>
                        <th data-sortable scope="col" role="columnheader">Message</th>
                    </tr>
                </thead>
                <tbody>
                    {% for errors in data.harvest_job.errors %}
                    <tr>
                        <td data-sort-value={errors.date_created}> {{errors.date_created}}</td>
                        <td data-sort-value={errors.id}>{{errors.id}}</td>
                        <td data-sort-value={errors.type}>{{errors.type}}</td>
                        <td data-sort-value={errors.message}>{{errors.message}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="usa-sr-only usa-table__announcement-region" aria-live="polite"></div>
        </div>
        {% endif %}
    </div>

    <div class="section">
        <h2>Record Error Details</h2>
        {% if not data.record_errors %}
            <p>No record errors found</p>
        {% else %}
        <button id="toggleViewBtn" onclick="toggleView()">Switch to Table View</button>
        <div class="usa-table-container--scrollable" tabindex="0">
            {% block record_errors_table %}
            <div id="error_results_pagination">
                <div id="blockView" class="error-list">
                    {% for record_error in data.record_errors %}
                        <div class="error-block">
                            <h3>{{ record_error.error.id }}</h3>
                            <p><strong>Identifier:</strong> {{ record_error.identifier }}</p>
                            <p><strong>Title:</strong> {{ record_error.title }}</p>
                            <p><strong>Harvest Record ID:</strong>
                                <a href="{{ url_for('harvest.get_harvest_record', record_id=record_error.error.harvest_record_id) }}">
                                    {{ record_error.error.harvest_record_id }}
                                </a>
                            </p>
                            <p><strong>Error Message:</strong> {{ record_error.error.message }}</p>
                            <p><strong>Type:</strong> {{ record_error.error.type }}</p>
                            <p><strong>Date Created:</strong> {{ record_error.error.date_created }}</p>

                        </div>
                    {% endfor %}
                </div>
                <table id="tableView" class="usa-table usa-table--striped" style="display: none;">
                    {% set error_type = "record" %}
                    <a href="{{ url_for('harvest.download_harvest_errors_by_job', job_id=data.harvest_job_id, error_type=error_type)}}">
                        <button class="btn btn-primary">download record errors as .csv</button>
                    </a>
                    <caption> Harvest Record Errors for {{data.harvest_job_id}}</caption>
                    <thead>
                        <tr>
                            <th data-sortable scope="col" role="columnheader">Date Created</th>
                            <th data-sortable scope="col" role="columnheader">ID</th>
                            <th data-sortable scope="col" role="columnheader">Title</th>
                            <th data-sortable scope="col" role="columnheader">Identifier</th>
                            <th data-sortable scope="col" role="columnheader">Harvest Record Id</th>
                            <th data-sortable scope="col" role="columnheader">Message</th>
                            <th data-sortable scope="col" role="columnheader">Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record_error in data.record_errors %}
                        <tr>
                            <td data-sort-value="{{ record_error.error.date_created }}"> {{ record_error.error.date_created }}</td>
                            <td>{{ record_error.error.id }}</td>
                            <td>{{ record_error.title }}</td>
                            <td>{{ record_error.identifier }}</td>
                            <td data-sort-value="{{ record_error.error.harvest_record_id }}">
                                <a href="{{ url_for('harvest.get_harvest_record', record_id=record_error.error.harvest_record_id) }}">
                                    {{ record_error.error.harvest_record_id }}
                                </a>
                            </td>
                            <td data-sort-value="{{ record_error.error.message }}"> {{ record_error.error.message }}</td>
                            <td data-sort-value="{{ record_error.error.type }}"> {{ record_error.error.type }}</td>
                        </tr>
                        {% endfor %}
                        {% if pagination.per_page > data.record_errors|count and pagination.count > data.record_errors|count %}
                            {% for number in range(pagination.per_page - data.record_errors|count) %}
                            <tr>
                                {% for number in range(5) %}
                                    <td>&nbsp;</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
                {% if pagination.count > data.record_errors|count %}
                    {% include '/components/pagination/pagination.html' %}
                {%endif%}
                <script>
                    document.addEventListener("DOMContentLoaded", function() {
                        setTimeout(function() {
                            let savedView = localStorage.getItem("errorView");
                            console.log("Applying saved view:", savedView);
                            if (!savedView) {
                                localStorage.setItem("errorView", "block");
                            }
                            applyView(savedView || "block");
                        }, 100);
                    });

                    function toggleView() {
                        var currentView = localStorage.getItem("errorView") === "table" ? "block" : "table";
                        localStorage.setItem("errorView", currentView);
                        console.log("View changed to:", currentView);
                        applyView(currentView);
                    }

                    function applyView(view) {
                        console.log("Applying view:", view);

                        var blockView = document.getElementById("blockView");
                        var tableView = document.getElementById("tableView");
                        var toggleBtn = document.getElementById("toggleViewBtn");

                        if (view === "table") {
                            blockView.style.display = "none";
                            tableView.style.display = "block";
                            toggleBtn.textContent = "Switch to Block View";
                        } else {
                            blockView.style.display = "block";
                            tableView.style.display = "none";
                            toggleBtn.textContent = "Switch to Table View";
                        }
                    }
                </script>
                

                <style>
                    .error-list {
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                    }
                    .error-block {
                        border: 1px solid #ccc;
                        padding: 15px;
                        border-radius: 5px;
                        background-color: #f9f9f9;
                    }
                    .error-block h3 {
                        margin: 0;
                        font-size: 1.2em;
                        font-weight: 900;
                    }
                    .error-block p {
                        margin: 5px 0;
                        font-size: 1em;
                        text-indent: 20px;
                    }
                    .error-block a {
                        color: #0071bc;
                        text-decoration: none;
                    }
                    .error-block a:hover {
                        text-decoration: underline;
                    }
                </style>
            </div>

            {% endblock %}
                <div class="usa-sr-only usa-table__announcement-region" aria-live="polite"></div>
            </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% endblock %}

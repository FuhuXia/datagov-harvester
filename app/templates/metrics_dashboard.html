{% extends 'base.html' %}

{% block title %}
<title>Metrics Dashboard</title>
{% endblock %}

{% block content %}
<div class="wrapper job-data">
    <div class="section my-3">
        <h2>Recent Harvest Jobs</h2>
        <p class="text-muted">
            Showing jobs from {{ window_start.strftime('%Y-%m-%d %H:%M:%S UTC') }}
            to {{ current_time.strftime('%Y-%m-%d %H:%M:%S UTC') }}
        </p>

        {% if jobs %}
        <div class="usa-table-container--scrollable" tabindex="0">
            <table class="usa-table usa-table--striped">
                <caption>Recent Harvest Jobs</caption>
                <thead>
                    <tr>
                        <th data-sortable scope="col" role="columnheader">Source ID</th>
                        <th data-sortable scope="col" role="columnheader">Status</th>
                        <th data-sortable scope="col" role="columnheader">Created</th>
                        <th data-sortable scope="col" role="columnheader">Records Added</th>
                        <th data-sortable scope="col" role="columnheader">Records Updated</th>
                        <th data-sortable scope="col" role="columnheader">Records Deleted</th>
                        <th data-sortable scope="col" role="columnheader">Records Errored</th>
                        <th scope="col" role="columnheader">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in jobs %}
                    <tr>
                        <td data-sort-value="{{ job.harvest_source_id }}">
                            <a
                                href="{{ url_for('harvest.view_harvest_source_data', source_id=job.harvest_source_id) }}">
                                {{ job.harvest_source_id[:8] }}...
                            </a>
                        </td>
                        <td data-sort-value="{{ job.status }}">
                            <span class="usa-tag {% if job.status == 'error' %}usa-tag--error
                                              {% elif job.status == 'in_progress' %}usa-tag--warning
                                              {% elif job.status == 'complete' %}usa-tag--success
                                              {% else %}usa-tag--base{% endif %}">
                                {{ job.status }}
                            </span>
                        </td>
                        <td data-sort-value="{{ job.date_created }}">{{ job.date_created.strftime('%Y-%m-%d %H:%M:%S')
                            }}</td>
                        <td data-sort-value="{{ job.records_added or 0 }}">{{ job.records_added or 0 }}</td>
                        <td data-sort-value="{{ job.records_updated or 0 }}">{{ job.records_updated or 0 }}</td>
                        <td data-sort-value="{{ job.records_deleted or 0 }}">{{ job.records_deleted or 0 }}</td>
                        <td data-sort-value="{{ job.records_errored or 0 }}">{{ job.records_errored or 0 }}</td>
                        <td>
                            <ul class="usa-button-group">
                                <li class="usa-button-group__item">
                                    <a href="{{ url_for('harvest.get_harvest_job', job_id=job.id) }}"
                                        class="usa-button usa-button--outline">
                                        View
                                    </a>
                                </li>
                                {% if job.status == 'in_progress' %}
                                <li class="usa-button-group__item">
                                    <a href="{{ url_for('harvest.cancel_harvest_job', job_id=job.id) }}"
                                        class="usa-button usa-button--secondary">
                                        Cancel
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="usa-sr-only usa-table__announcement-region" aria-live="polite"></div>
        </div>

        {% if pagination.page_count > 1 %}
        {% include '/components/pagination/pagination.html' %}
        {% endif %}

        {% else %}
        <div class="usa-alert usa-alert--info">
            <div class="usa-alert__body">
                <p class="usa-alert__text">
                    No harvest jobs found in the last 24 hours.
                </p>
            </div>
        </div>
        {% endif %}
    </div>
    {% endblock %}
